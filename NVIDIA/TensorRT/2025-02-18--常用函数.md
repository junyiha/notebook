---
category: NVIDIA
date: 2025-02-18 09:00:00 +0800
layout: post
title: TensorRT å¸¸ç”¨å‡½æ•°
tag: TensorRT
---
## æ‘˜è¦

+ TensorRT å¸¸ç”¨å‡½æ•°

<!--more-->

## nvinfer1::createInferRuntime() å‡½æ•° è¯¦è§£

### `nvinfer1::createInferRuntime()` å‡½æ•°è¯¦è§£

#### **1. ä½œç”¨**
`nvinfer1::createInferRuntime()` ç”¨äºåˆ›å»º TensorRT çš„æ¨ç†è¿è¡Œæ—¶ï¼ˆInfer Runtimeï¼‰å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºç®¡ç† TensorRT æ¨ç†ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚ååºåˆ—åŒ–å¼•æ“ã€æ‰§è¡Œæ¨ç†ç­‰ã€‚

#### **2. è¯­æ³•**
```cpp
#include "NvInfer.h"

nvinfer1::IRuntime* createInferRuntime(nvinfer1::ILogger& logger);
```
- **å‚æ•°**
  - `logger`ï¼šä¸€ä¸ª `nvinfer1::ILogger` ç±»å‹çš„å¯¹è±¡ï¼Œç”¨äºè®°å½• TensorRT è¿è¡Œæ—¶çš„æ—¥å¿—ä¿¡æ¯ã€‚
- **è¿”å›å€¼**
  - è¿”å›ä¸€ä¸ª `nvinfer1::IRuntime*` æŒ‡é’ˆï¼ˆå³æ¨ç†è¿è¡Œæ—¶å¯¹è±¡ï¼‰ã€‚
  - å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè¿”å› `nullptr`ã€‚

#### **3. ç›¸å…³è¯´æ˜**
- `createInferRuntime()` ç”± `nvinfer1` å‘½åç©ºé—´æä¾›ï¼Œéœ€è¦åŒ…å« TensorRT å¤´æ–‡ä»¶ `NvInfer.h`ã€‚
- ç”Ÿæˆçš„ `IRuntime` å¯¹è±¡ç”¨äºåŠ è½½ TensorRT åºåˆ—åŒ–çš„æ¨¡å‹ï¼ˆå³ `ICudaEngine`ï¼‰ï¼Œç„¶åè¿›è¡Œæ¨ç†ã€‚
- éœ€è¦åœ¨ä½¿ç”¨å®Œæ¯•åæ‰‹åŠ¨é‡Šæ”¾ `IRuntime`ï¼Œè°ƒç”¨ `IRuntime::destroy()` æˆ– `delete` é‡Šæ”¾èµ„æºã€‚

#### **4. ä»£ç ç¤ºä¾‹**
```cpp
#include <NvInfer.h>
#include <iostream>

class Logger : public nvinfer1::ILogger {
public:
    void log(Severity severity, const char* msg) noexcept override {
        if (severity <= Severity::kWARNING) {
            std::cout << "[TensorRT] " << msg << std::endl;
        }
    }
};

int main() {
    Logger logger;
    
    // åˆ›å»ºæ¨ç†è¿è¡Œæ—¶
    nvinfer1::IRuntime* runtime = nvinfer1::createInferRuntime(logger);
    if (!runtime) {
        std::cerr << "Failed to create TensorRT runtime!" << std::endl;
        return -1;
    }

    std::cout << "TensorRT runtime created successfully!" << std::endl;

    // é‡Šæ”¾èµ„æº
    runtime->destroy();  // æˆ–è€… delete runtime;

    return 0;
}
```

#### **5. ç»“åˆ `deserializeCudaEngine()` è¿›è¡Œæ¨¡å‹åŠ è½½**
é€šå¸¸ï¼Œæˆ‘ä»¬ä½¿ç”¨ `createInferRuntime()` æ¥ååºåˆ—åŒ– TensorRT ç”Ÿæˆçš„ `.engine` æ–‡ä»¶ï¼š
```cpp
std::ifstream file("model.engine", std::ios::binary);
file.seekg(0, std::ios::end);
size_t size = file.tellg();
file.seekg(0, std::ios::beg);
std::vector<char> engineData(size);
file.read(engineData.data(), size);
file.close();

// ååºåˆ—åŒ– TensorRT å¼•æ“
nvinfer1::ICudaEngine* engine = runtime->deserializeCudaEngine(engineData.data(), size, nullptr);
if (!engine) {
    std::cerr << "Failed to load TensorRT engine!" << std::endl;
}

// é‡Šæ”¾èµ„æº
engine->destroy();
runtime->destroy();
```

#### **6. æ³¨æ„äº‹é¡¹**
- `createInferRuntime()` åªèƒ½ç”¨äºååºåˆ—åŒ–å¼•æ“ï¼ˆå³æ¨ç†é˜¶æ®µï¼‰ï¼Œä¸èƒ½ç”¨äºåˆ›å»ºå’Œç¼–è¯‘æ–°çš„æ¨¡å‹ï¼ˆåº”ä½¿ç”¨ `createInferBuilder()`ï¼‰ã€‚
- `IRuntime` ä¸æ”¯æŒåˆ›å»º `ICudaEngine`ï¼Œå®ƒåªèƒ½é€šè¿‡ `deserializeCudaEngine()` åŠ è½½å·²ç»åºåˆ—åŒ–çš„ `.engine` æ–‡ä»¶ã€‚
- `IRuntime` å¿…é¡»åœ¨æ‰€æœ‰ TensorRT èµ„æºï¼ˆå¦‚ `ICudaEngine`ï¼‰é‡Šæ”¾åå†é”€æ¯ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼æˆ–é”™è¯¯ã€‚

#### **7. æ€»ç»“**
- `createInferRuntime()` ç”¨äºåˆ›å»º TensorRT æ¨ç†è¿è¡Œæ—¶ã€‚
- éœ€è¦æä¾› `ILogger` è®°å½•æ—¥å¿—ã€‚
- ä¸»è¦ç”¨äº `deserializeCudaEngine()` ååºåˆ—åŒ– TensorRT å¼•æ“ã€‚
- éœ€è¦æ‰‹åŠ¨é‡Šæ”¾èµ„æºï¼Œè°ƒç”¨ `destroy()`ã€‚

è¿™ä¸ªå‡½æ•°æ˜¯ TensorRT è¿›è¡Œæ¨ç†çš„æ ¸å¿ƒæ­¥éª¤ä¹‹ä¸€ï¼Œåˆç†ä½¿ç”¨å¯ä»¥æå‡æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ€§èƒ½ã€‚ ğŸš€

## C++ createInferBuilder() å‡½æ•° è¯¦è§£

åœ¨C++ä¸­ï¼Œ`createInferBuilder()` å‡½æ•°é€šå¸¸æ˜¯ä¸NVIDIA TensorRTåº“ç›¸å…³çš„ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª TensorRT çš„æ¨ç†æ„å»ºå™¨ï¼ˆInferBuilderï¼‰ã€‚TensorRTæ˜¯ä¸€ä¸ªç”¨äºæ·±åº¦å­¦ä¹ æ¨ç†çš„é«˜æ€§èƒ½æ¨ç†å¼•æ“ï¼Œç”±NVIDIAæä¾›ã€‚

ä»¥ä¸‹æ˜¯å¯¹ `createInferBuilder()` å‡½æ•°çš„è¯¦è§£ï¼š

```cpp
nvinfer1::IBuilder* createInferBuilder(nvinfer1::ILogger& logger);
```

åœ¨è¿™é‡Œï¼Œ`createInferBuilder()` å‡½æ•°è¿”å›ä¸€ä¸ª `nvinfer1::IBuilder*` æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ TensorRT æ¨ç†æ„å»ºå™¨ï¼ˆInferBuilderï¼‰ã€‚è®©æˆ‘ä»¬å¯¹å‚æ•°å’Œè¿”å›å€¼è¿›è¡Œè¯¦ç»†è§£é‡Šï¼š

- **å‚æ•°ï¼š**
  - `nvinfer1::ILogger& logger`ï¼šä¸€ä¸ª TensorRT æä¾›çš„æ—¥å¿—è®°å½•å™¨ï¼ˆILoggerï¼‰å¼•ç”¨ã€‚æ—¥å¿—è®°å½•å™¨ç”¨äºåœ¨ TensorRT è¿è¡Œæ—¶è®°å½•å„ç§ä¿¡æ¯ï¼ŒåŒ…æ‹¬è­¦å‘Šã€é”™è¯¯ç­‰ã€‚é€šè¿‡ä¼ é€’ä¸€ä¸ªæ—¥å¿—è®°å½•å™¨å¼•ç”¨ï¼Œæ‚¨å¯ä»¥æ•è· TensorRT çš„è¿è¡Œæ—¶æ¶ˆæ¯ã€‚

- **è¿”å›å€¼ï¼š**
  - `nvinfer1::IBuilder*`ï¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ TensorRT æ¨ç†æ„å»ºå™¨çš„æŒ‡é’ˆã€‚è¯¥æŒ‡é’ˆå¯ä»¥ç”¨äºé…ç½®å’Œæ„å»ºæ¨ç†å¼•æ“ã€‚

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```cpp
#include <NvInfer.h>

int main() {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æ—¥å¿—è®°å½•å™¨
    nvinfer1::ILogger* logger = new nvinfer1::Logger(nvinfer1::ILogger::Severity::kINFO);

    // ä½¿ç”¨ createInferBuilder() åˆ›å»º TensorRT æ¨ç†æ„å»ºå™¨
    nvinfer1::IBuilder* builder = createInferBuilder(*logger);

    // åœ¨è¿™é‡Œå¯ä»¥é…ç½®å’Œæ„å»ºæ¨ç†å¼•æ“

    // é‡Šæ”¾èµ„æº
    builder->destroy();
    delete logger;

    return 0;
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—è®°å½•å™¨ï¼Œç„¶åä½¿ç”¨ `createInferBuilder()` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª TensorRT æ¨ç†æ„å»ºå™¨ã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥æ„å»ºå™¨é…ç½®å’Œæ„å»ºæ¨ç†å¼•æ“ã€‚æœ€åï¼Œè®°å¾—é‡Šæ”¾èµ„æºï¼ŒåŒ…æ‹¬é”€æ¯æ„å»ºå™¨å’Œé‡Šæ”¾æ—¥å¿—è®°å½•å™¨ã€‚