---
category: ComputerVision
date: 2025-05-08 09:00:00 +0800
layout: post
title: 相机参数
tag: ComputerVision
---
## 摘要

+ 理解，学习相机参数

<!--more-->

## 相机内参与外参

相机内参（Intrinsic Parameters）和外参（Extrinsic Parameters）是计算机视觉和摄影测量中的核心概念，用于描述相机的几何成像模型。它们共同定义了三维世界中的点如何投影到二维图像平面上。

---

### **1. 相机内参（Intrinsic Parameters）**
内参描述相机**自身的属性**，与相机的位置和方向无关，主要包括以下参数：

#### **1.1 内参矩阵（K）**
内参矩阵是一个 3×3 的矩阵，形式如下：
\[
K = \begin{bmatrix}
f_x & s & u_0 \\
0 & f_y & v_0 \\
0 & 0 & 1
\end{bmatrix}
\]
- **\(f_x, f_y\)**：沿图像 x 轴和 y 轴的焦距（单位为像素）。焦距反映相机的缩放能力，决定了物体在图像中的大小。
- **\(u_0, v_0\)**：主点（Principal Point）坐标，即图像坐标系的原点（通常是图像中心附近的像素坐标）。
- **\(s\)**：轴倾斜因子（Skew Factor），描述图像 x 轴和 y 轴的不垂直性，现代相机通常为 0。

#### **1.2 畸变参数（Distortion Coefficients）**
用于校正镜头的非线性畸变（如径向畸变、切向畸变），常见参数包括：
- **\(k_1, k_2, k_3\)**：径向畸变系数（如桶形畸变、枕形畸变）。
- **\(p_1, p_2\)**：切向畸变系数（由镜头与传感器不平行引起）。

#### **1.3 作用**
内参将**相机坐标系**下的三维点投影到**图像坐标系**中，完成归一化成像过程。

---

### **2. 相机外参（Extrinsic Parameters）**
外参描述相机的**位置和方向**在世界坐标系中的关系，即相机的刚体变换（旋转和平移）。

#### **2.1 外参矩阵**
外参矩阵是一个 3×4 的矩阵，由旋转矩阵 \(R\) 和平移向量 \(T\) 组成：
\[
[R \ | \ T] = \begin{bmatrix}
r_{11} & r_{12} & r_{13} & t_x \\
r_{21} & r_{22} & r_{23} & t_y \\
r_{31} & r_{32} & r_{33} & t_z
\end{bmatrix}
\]
- **\(R\)**：3×3 的旋转矩阵，表示相机坐标系相对于世界坐标系的旋转。
- **\(T\)**：3×1 的平移向量，表示相机坐标系原点在世界坐标系中的位置。

#### **2.2 作用**
外参将世界坐标系中的三维点转换到**相机坐标系**中，完成从世界到相机的坐标变换。

---

### **3. 投影过程**
三维点 \(P_w = [X_w, Y_w, Z_w]^T\) 到图像点 \(p = [u, v]^T\) 的投影过程：
\[
p = K \cdot [R \ | \ T] \cdot P_w
\]
具体步骤：
1. **世界坐标系 → 相机坐标系**：通过外参 \([R \ | \ T]\) 转换。
2. **相机坐标系 → 图像坐标系**：通过内参 \(K\) 投影。
3. **畸变校正**：应用畸变参数修正图像坐标。

---

### **4. 标定（Calibration）**
通过标定（如使用棋盘格）可以获取相机的内外参：
- **内参标定**：确定 \(K\) 和畸变参数。
- **外参标定**：确定每个视角下的 \(R\) 和 \(T\)。

---

### **5. 应用场景**
- **内参**：图像去畸变、单目深度估计、虚拟视图生成。
- **外参**：多视角立体视觉（如三维重建）、SLAM（同时定位与地图构建）、AR/VR 中的虚实融合。

---

### **总结**
- **内参**：相机的“内部属性”，决定成像几何。
- **外参**：相机的“外部位姿”，决定观测视角。
- 两者共同完成从三维世界到二维图像的映射，是计算机视觉任务的数学基础。

## 内参标定

相机内参标定（Intrinsic Calibration）是确定相机内部参数（如焦距、主点、畸变系数等）的过程。它是计算机视觉、机器人、三维重建等领域的基础步骤，直接影响后续任务的精度（如目标检测、SLAM、AR/VR等）。以下是内参标定的详细流程和关键知识：

---

### **1. 标定原理**
内参标定通过分析已知几何形状的标定物（如棋盘格）在图像中的投影，建立三维世界点到二维图像点的映射关系，利用优化算法求解内参矩阵和畸变参数。

#### **核心数学模型**
\[
s \cdot \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = 
K \cdot \begin{bmatrix} 
R \ | \ T 
\end{bmatrix} \cdot 
\begin{bmatrix} X_w \\ Y_w \\ Z_w \\ 1 \end{bmatrix}
\]
- \(s\) 为尺度因子，\(K\) 为内参矩阵，\([R \ | \ T]\) 为外参矩阵。
- 通过多组对应点（棋盘格角点），最小化重投影误差，求解最优参数。

---

### **2. 标定工具与方法**
#### **2.1 常用标定物**
- **棋盘格（Checkerboard）**：最常用，角点检测简单且精度高。
- **圆形网格（Circle Grid）**：适合低分辨率或模糊图像。
- **Charuco标定板**：结合棋盘格和ArUco标记，抗遮挡能力强。

#### **2.2 标定算法**
- **张正友标定法（Zhang's Method）**：
  - 只需拍摄多张不同角度的棋盘格图像。
  - 利用单应性矩阵（Homography）和最大似然估计（MLE）求解参数。
  - 开源实现：OpenCV的 `cv2.calibrateCamera()` 函数。

#### **2.3 标定步骤**
1. **准备标定板**：
   - 打印棋盘格（推荐不对称行列数，如8×6角点），确保平整无褶皱。
   - 已知棋盘格的实际尺寸（如每个方格边长25mm）。

2. **采集图像**：
   - 从不同角度、距离、位置拍摄15~20张棋盘格图像（覆盖图像边缘区域）。
   - 确保棋盘格在图像中完整可见，避免强反光或模糊。

3. **角点检测**：
   - 使用OpenCV的 `findChessboardCorners()` 检测角点。
   - 亚像素优化：`cornerSubPix()` 提高角点定位精度。

4. **参数求解**：
   - 调用 `calibrateCamera()` 计算内参矩阵、畸变系数、外参矩阵和重投影误差。
   - 关键参数：
     ```python
     ret, K, dist, rvecs, tvecs = cv2.calibrateCamera(
         object_points,  # 三维标定板角点坐标
         image_points,   # 二维图像角点坐标
         image_size,     # 图像分辨率（如(1920, 1080)）
         None, None
     )
     ```

5. **验证与优化**：
   - **重投影误差**（Reprojection Error）：一般要求小于0.5像素。
   - 若误差较大，需检查标定板图像质量或增加样本数量。

---

### **3. 畸变校正**
内参标定后，需对图像进行畸变校正：
```python
# 计算去畸变映射
h, w = image.shape[:2]
new_K, roi = cv2.getOptimalNewCameraMatrix(K, dist, (w, h), 1, (w, h))
mapx, mapy = cv2.initUndistortRectifyMap(K, dist, None, new_K, (w, h), cv2.CV_32FC1)

# 应用去畸变
undistorted_img = cv2.remap(image, mapx, mapy, cv2.INTER_LINEAR)
```

---

### **4. 关键注意事项**
1. **标定板质量**：
   - 高对比度、边缘清晰，避免反光或变形。
   - 实际尺寸需精确测量（直接影响标定结果）。

2. **图像采集多样性**：
   - 覆盖图像不同区域（尤其边缘），倾斜、旋转、远近多角度拍摄。
   - 避免纯正面或纯侧面拍摄（可能导致参数退化）。

3. **光照条件**：
   - 均匀光照，避免阴影或过曝。

4. **标定结果验证**：
   - 检查校正后图像的直线是否笔直（如棋盘格边缘）。
   - 重投影误差需足够小（典型值：0.1~0.5像素）。

---

### **5. 工具与代码示例**
#### **5.1 OpenCV标定代码片段**
```python
import cv2
import numpy as np

# 标定板参数
CHECKERBOARD = (7, 10)  # 角点行列数（实际角点数减1）
square_size = 25.0      # 棋盘格方块实际尺寸（单位：mm）

# 准备三维角点坐标
objp = np.zeros((CHECKERBOARD[0]*CHECKERBOARD[1], 3), np.float32)
objp[:, :2] = np.mgrid[0:CHECKERBOARD[1], 0:CHECKERBOARD[0]].T.reshape(-1, 2) * square_size

# 存储检测到的角点
objpoints = []  # 三维点
imgpoints = []  # 二维点

# 读取标定图像
images = glob.glob('calibration_images/*.jpg')
for fname in images:
    img = cv2.imread(fname)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    
    # 检测角点
    ret, corners = cv2.findChessboardCorners(gray, CHECKERBOARD, None)
    if ret:
        objpoints.append(objp)
        corners_refined = cv2.cornerSubPix(gray, corners, (11,11), (-1,-1), 
                                         criteria=(cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 30, 0.001))
        imgpoints.append(corners_refined)

# 标定相机
ret, K, dist, rvecs, tvecs = cv2.calibrateCamera(objpoints, imgpoints, gray.shape[::-1], None, None)

print("内参矩阵 K:\n", K)
print("畸变系数 dist:\n", dist)
```

#### **5.2 自动化工具**
- **MATLAB Camera Calibrator**：图形化界面，适合快速标定。
- **Kalibr**（ROS环境）：支持多相机、IMU联合标定。
- **COLMAP**：基于SFM（运动恢复结构）的无标定板标定。

---

### **6. 常见问题**
- **标定失败**：角点检测错误 → 检查标定板是否对称，或改用Charuco板。
- **重投影误差大**：增加标定图像数量或优化拍摄角度。
- **焦距异常**：单位混淆（物理焦距 vs. 像素焦距）→ 检查标定板尺寸单位。

---

### **总结**
内参标定是计算机视觉任务的基石，需严格遵循流程并验证结果。通过合理选择标定板、多样化采集图像，结合OpenCV等工具，可高效获取高精度内参。标定后务必通过畸变校正和重投影误差验证结果的可靠性。

## 外参标定

相机外参标定（Extrinsic Calibration）是确定相机在世界坐标系中的位置（平移）和朝向（旋转）的过程。外参标定与内参标定共同构成了完整的相机模型，使三维世界坐标与二维图像坐标之间的映射成为可能。以下是外参标定的核心知识、方法及实践指南：

---

### **1. 外参标定原理**
外参矩阵由 **旋转矩阵 \(R\)** 和 **平移向量 \(T\)** 组成，描述从 **世界坐标系** 到 **相机坐标系** 的刚体变换关系。数学形式为：
\[
P_c = R \cdot P_w + T
\]
其中：
- \(P_w = [X_w, Y_w, Z_w]^T\) 是世界坐标系中的点，
- \(P_c = [X_c, Y_c, Z_c]^T\) 是相机坐标系中的点。

外参标定的核心任务是求解 \(R\) 和 \(T\)。

---

### **2. 标定场景与方法**
#### **2.1 基于已知标定物的标定**
**适用场景**：单相机与固定世界坐标系的关系标定（如工业检测、机器人抓取）。  
**标定物**：棋盘格、ArUco标记、AprilTag等已知几何形状的物体。  
**步骤**：
1. **标定物放置**：将标定物固定在世界坐标系的原点（如地面、工作台）。
2. **检测特征点**：在图像中检测标定物的角点或标记中心。
3. **求解外参**：利用3D-2D点对应关系，通过 **PnP（Perspective-n-Point）算法** 计算外参。

#### **2.2 多相机外参标定**
**适用场景**：多目立体视觉系统（如双目、多视角三维重建）。  
**方法**：
- **两相机标定**：通过标定板或共视特征点，计算两相机之间的相对外参 \(R_{12}, T_{12}\)。
- **多相机标定**：以某一相机为参考坐标系，依次标定其他相机与该相机的相对外参。

#### **2.3 相机-其他传感器联合标定**
**适用场景**：自动驾驶（相机与LiDAR/IMU）、机器人（相机与机械臂）。  
**方法**：
- **手眼标定（Hand-Eye Calibration）**：标定相机与机械臂末端（Eye-in-Hand）或基座（Eye-to-Hand）的关系。
- **LiDAR-相机标定**：通过点云与图像的对应特征（如棋盘格角点）求解外参。

---

### **3. 标定工具与算法**
#### **3.1 PnP算法**
- **原理**：利用至少4组3D世界点与2D图像点的对应关系，求解相机外参。
- **常用算法**：
  - **EPnP**（Efficient PnP）：高效求解，适合实时应用。
  - **SolvePnP**（OpenCV实现）：支持EPnP、Iterative、AP3P等多种方法。
- **代码示例**：
  ```python
  import cv2
  import numpy as np

  # 已知世界坐标点（假设标定板位于Z=0平面）
  world_points = np.array([[0,0,0], [25,0,0], [25,25,0], [0,25,0]], dtype=np.float32)  # 单位：mm

  # 对应图像坐标点（通过角点检测获取）
  image_points = np.array([[320,240], [480,240], [480,400], [320,400]], dtype=np.float32)

  # 已知相机内参矩阵K和畸变系数dist
  K = np.array([[800, 0, 320], [0, 800, 240], [0, 0, 1]])
  dist = np.array([0.1, -0.05, 0, 0])  # k1, k2, p1, p2

  # 使用SolvePnP求解外参
  success, rvec, tvec = cv2.solvePnP(world_points, image_points, K, dist)

  # 将旋转向量转换为旋转矩阵
  R, _ = cv2.Rodrigues(rvec)
  print("旋转矩阵 R:\n", R)
  print("平移向量 T:\n", tvec)
  ```

#### **3.2 标定工具**
- **OpenCV**：`solvePnP()`、`calibrateCamera()`（联合标定内外参）。
- **ROS**：`camera_calibration` 包（支持多相机标定）、`kalibr`（多传感器联合标定）。
- **MATLAB**：`estimateCameraParameters()`、`extrinsics()`。

---

### **4. 标定步骤（以棋盘格为例）**
1. **准备标定环境**：
   - 将棋盘格固定在世界坐标系的原点（如水平桌面）。
   - 确保棋盘格平面与某一世界坐标轴对齐（如Z=0平面）。

2. **采集图像**：
   - 单相机：拍摄至少1张包含完整棋盘格的图像。
   - 多相机：同步采集各相机的棋盘格图像。

3. **特征点检测**：
   - 使用OpenCV的 `findChessboardCorners()` 或 `detectMarkers()`（ArUco）提取角点坐标。
   - 亚像素优化提升精度。

4. **外参求解**：
   - 单相机：调用 `solvePnP()` 直接计算外参。
   - 多相机：通过共视区域的特征点计算相对外参。

5. **验证标定结果**：
   - **重投影误差**：将世界点投影到图像，计算与检测点的像素误差。
   - **可视化验证**：在图像中绘制投影后的坐标系箭头（见下图）。
     ```python
     # 绘制坐标系轴
     axis_points = np.float32([[50,0,0], [0,50,0], [0,0,50], [0,0,0]]).reshape(-1,3)
     img_points, _ = cv2.projectPoints(axis_points, rvec, tvec, K, dist)
     img = cv2.line(img, tuple(img_points[3].ravel()), tuple(img_points[0].ravel()), (0,0,255), 5)  # X轴（红）
     img = cv2.line(img, tuple(img_points[3].ravel()), tuple(img_points[1].ravel()), (0,255,0), 5)  # Y轴（绿）
     img = cv2.line(img, tuple(img_points[3].ravel()), tuple(img_points[2].ravel()), (255,0,0), 5)  # Z轴（蓝）
     ```

---

### **5. 关键注意事项**
1. **标定物精度**：
   - 标定板的尺寸需精确测量（误差直接影响外参精度）。
   - 棋盘格需平整，避免因弯曲导致坐标误差。

2. **多视角覆盖**：
   - 对于动态外参（如移动机器人），需在运动范围内多次标定。
   - 避免所有图像中棋盘格位姿过于相似（可能导致求解退化）。

3. **坐标系对齐**：
   - 明确世界坐标系的定义（如标定板中心为原点，X/Y轴方向）。
   - 在多传感器系统中，统一各传感器的参考坐标系。

4. **标定结果稳定性**：
   - 多次标定取平均，或使用RANSAC剔除异常值。
   - 对于机械振动或温度变化敏感的场景，需定期重新标定。

---

### **6. 常见问题与解决**
| **问题**                | **原因**                          | **解决方案**                          |
|-------------------------|-----------------------------------|---------------------------------------|
| 重投影误差大            | 角点检测不准或标定板尺寸错误      | 检查标定板测量，优化角点检测算法       |
| 外参跳变（不稳定）       | 图像模糊或标定板位姿变化不足      | 增加标定图像数量，覆盖更多视角         |
| Z轴方向错误（镜像问题）  | PnP求解的深度方向歧义             | 约束标定板位于相机前方（Z>0）          |
| 多相机外参不一致         | 共视区域不足或标定板移动          | 确保所有相机同步拍摄同一标定板         |

---

### **7. 高级应用**
- **在线外参标定**：  
  适用于自动驾驶或无人机，通过SLAM（如ORB-SLAM）实时估计相机位姿。
- **无标定板标定**：  
  基于自然场景特征（如SIFT、ORB），通过SfM（运动恢复结构）估计外参。
- **深度学习辅助标定**：  
  使用神经网络直接预测外参（如6DoF位姿估计网络）。

---

### **总结**
外参标定是连接三维世界与二维图像的关键步骤，需结合场景需求选择合适方法。对于固定场景，棋盘格+PnP是高效方案；对于动态或多传感器系统，需借助更复杂的工具（如Kalibr）。标定后务必通过重投影误差和可视化验证结果，确保后续应用（如三维重建、目标定位）的精度。