---
category: ComputerVision
date: 2025-05-06 09:00:00 +0800
layout: post
title: 霍夫圆检测原理
tag: ComputerVision
---
## 摘要

+ 理解，学习霍夫圆检测原理

<!--more-->

## 霍夫圆检测

+ 霍夫圆检测能检测出目标图像中存在的圆，但在实际使用中，参数调节存在很大的困难。

## 基本原理

+ 霍夫圆检测与霍夫变换密切相关，霍夫变换是基于极坐标系(是由半径与夹角所描述的一种坐标系)与笛卡尔坐标系(普通的平面坐标系)的相互转变而实现的。笛卡尔坐标系上的一个点，变换到极坐标系上就变成了一条线；反之亦然。
+ 然而，基于霍夫变换的霍夫圆检测方法计算量极大，不适合实际应用。
+ 在opencv的实现中，是使用霍夫梯度算法进行圆检测

## 霍夫梯度法的原理

1. 把原图做一次Canny边缘检测，得到边缘检测的二值图
2. 对原始图像执行一次Sobel算子，计算出所有像素的邻域梯度值
3. 初始化圆心空间N(a, b)，令所有的N(a, b) = 0。若要求圆心在图像中，则a，b值的范围分别对应图像的宽高，N(a, b)表示一共有 a * b个。
4. 遍历Canny边缘二值图中的所有非零像素点，沿着梯度方向(切线的垂直方向，根据Sobel算子计算出的垂直梯度及水平梯度得来)固定搜索半径范围画线，将线段经过的所有累加器中的点(a, b)的N(a, b) += 1
5. 统计排序N(a, b)，得到可能的圆心。 N(a, b)越大，越有可能是圆心。

## 霍夫梯度法缺点

+ 在霍夫梯度法中，使用Sobel导数来计算局部梯度，那么随之而来的假设是，其可以视作等同于一条基于几个局部点的切线，并且这个不是一个数值稳定的做法。在大多数情况下，这样做会得到正确的结果，但或许会在输出中产生一些噪声
+ 在边缘图像中的整个非0像素被看作每个中心的候选部分，若没有合理设置梯度方向的搜索半径范围，则会导致计算量巨大
+ 因为霍夫梯度算法通过圆弧切线的垂直线进行圆心累加检测，当存在同心圆时，会累加到同一个圆心，这导致指挥选择到累加值最大的圆。

霍夫圆检测是一种基于霍夫变换的图像处理技术，用于检测图像中的圆形。其核心思想是将图像空间中的圆转换为参数空间进行投票，通过累加器确定最可能的圆心和半径。以下是霍夫圆检测的详细步骤及关键要点：

### **霍夫圆检测原理**
1. **圆的参数表示**  
   圆的方程为 \((x-a)^2 + (y-b)^2 = r^2\)，其中 \((a, b)\) 为圆心，\(r\) 为半径。参数空间为三维（a, b, r），直接遍历计算复杂度高。

2. **梯度方向优化**  
   使用梯度方向信息简化计算：
   - 对边缘点进行梯度计算（如Sobel算子），确定边缘的法线方向（指向圆心）。
   - 沿梯度方向画线，累加可能的圆心 \((a, b)\)。多个边缘点的梯度线交点即为候选圆心。
   - 统计候选圆心到边缘点的距离，确定半径 \(r\)（出现次数最多的距离值）。

### **算法步骤**
1. **预处理**  
   - **高斯滤波**：平滑图像以减少噪声。
   - **边缘检测**：使用Canny检测器提取边缘点，得到二值边缘图像和梯度方向。

2. **圆心检测**  
   - 对每个边缘点，沿梯度方向在参数空间 \((a, b)\) 中累加可能的圆心位置。
   - 设定阈值（如`param2`），筛选出高投票数的候选圆心。

3. **半径确定**  
   - 对每个候选圆心，计算所有关联边缘点到圆心的距离。
   - 构建半径直方图，选择出现次数最多的半径作为最终结果。

4. **后处理**  
   - **非极大值抑制**：合并邻近的相似圆。
   - 根据参数（如`minDist`）过滤重叠圆。

### **关键参数解析（以OpenCV为例）**
- **`dp`**：累加器分辨率与图像分辨率之比。值越大，累加器越小（计算快但精度低）。
- **`minDist`**：圆之间的最小距离，避免重复检测。
- **`param1`**：Canny边缘检测的高阈值，低阈值为其一半。
- **`param2`**：圆心累加器阈值，值越高检测条件越严格。
- **`minRadius`/`maxRadius`**：限制检测的半径范围，减少计算量。

### **优化与注意事项**
- **梯度方向准确性**：噪声可能导致梯度方向偏差，需通过高斯滤波改善。
- **计算效率**：通过限制半径范围和调整`dp`参数平衡速度与精度。
- **参数调优**：需根据具体图像调整阈值和半径范围，避免过拟合或漏检。

### **示例代码（OpenCV）**
```python
import cv2
import numpy as np

img = cv2.imread('circles.jpg', 0)
img = cv2.medianBlur(img, 5)
cimg = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)

circles = cv2.HoughCircles(
    image=img,
    method=cv2.HOUGH_GRADIENT,
    dp=1,
    minDist=20,
    param1=50,
    param2=30,
    minRadius=10,
    maxRadius=50
)

if circles is not None:
    circles = np.uint16(np.around(circles))
    for (x, y, r) in circles[0, :]:
        cv2.circle(cimg, (x, y), r, (0, 255, 0), 2)

cv2.imshow('Detected Circles', cimg)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### **总结**
霍夫圆检测通过梯度方向优化，将三维参数空间分解为二维圆心和一维半径问题，显著提升效率。其性能依赖于梯度准确性、参数调优及预处理步骤，适用于已知半径范围且边缘清晰的圆形检测场景。

## 霍夫圆检测调试技巧

在霍夫圆检测（Hough Circle Detection）的实际应用中，调试参数是确保检测效果的关键。以下是针对霍夫圆检测的调试技巧和常见问题解决方案，结合OpenCV的`HoughCircles`函数进行说明：

---

### **1. 预处理优化**
霍夫圆检测对边缘质量和梯度方向非常敏感，预处理直接影响检测效果：

- **降噪处理**  
  - **高斯滤波**：通过`cv2.GaussianBlur`或`cv2.medianBlur`平滑图像，减少噪声对梯度计算的干扰。  
  ```python
  img = cv2.medianBlur(img, 5)  # 中值滤波对椒盐噪声更有效
  ```
  - **自适应阈值**：若图像光照不均，使用`cv2.adaptiveThreshold`代替全局阈值。

- **边缘检测优化**  
  - **Canny参数调整**：`param1`参数对应Canny的高阈值（低阈值为其一半）。  
    - **边缘断裂**：降低`param1`以保留更多边缘（但可能引入噪声）。  
    - **噪声过多**：增大`param1`或先进行更严格的降噪。

---

### **2. 参数调试策略**
OpenCV的`HoughCircles`主要参数如下：
```python
circles = cv2.HoughCircles(
    image, 
    method=cv2.HOUGH_GRADIENT, 
    dp=1, 
    minDist=20, 
    param1=50, 
    param2=30, 
    minRadius=0, 
    maxRadius=0
)
```

#### **(1) `dp`（累加器分辨率）**
- **作用**：控制累加器分辨率与图像分辨率的比例（`dp=1`表示与图像相同，`dp=2`表示缩小一倍）。  
- **调试技巧**：  
  - **检测不到圆**：降低`dp`（如`dp=0.8`），提高累加器分辨率。  
  - **计算速度慢**：增大`dp`（如`dp=1.5`），牺牲精度换取速度。

#### **(2) `minDist`（圆间最小距离）**
- **作用**：防止检测到重叠的圆。  
- **调试技巧**：  
  - **多个圆被合并**：增大`minDist`（如设置为图像宽度的1/10）。  
  - **漏检邻近圆**：减小`minDist`，但需结合`param2`避免误检。

#### **(3) `param1`（Canny高阈值）**
- **作用**：控制边缘检测的敏感度。  
- **调试技巧**：  
  - **边缘缺失**：降低`param1`（如`param1=30`）。  
  - **噪声过多**：增大`param1`（如`param1=100`）。

#### **(4) `param2`（圆心累加器阈值）**
- **作用**：决定被接受为圆的最小投票数（阈值越高，条件越严格）。  
- **调试技巧**：  
  - **漏检真圆**：降低`param2`（如`param2=20`）。  
  - **误检假圆**：增大`param2`（如`param2=50`）。

#### **(5) `minRadius`和`maxRadius`（半径范围）**
- **作用**：限制检测的半径范围，减少计算量。  
- **调试技巧**：  
  - **已知半径范围**：直接设置`minRadius`和`maxRadius`。  
  - **未知半径**：设为`0`，但需增大`param2`避免噪声干扰。

---

### **3. 分步调试技巧**
#### **(1) 可视化边缘检测结果**
在调用`HoughCircles`前，先验证Canny边缘检测的结果：
```python
edges = cv2.Canny(img, param1//2, param1)  # 低阈值为param1的一半
cv2.imshow('Edges', edges)
```
- **目标**：确保目标圆的边缘连续且噪声较少。

#### **(2) 圆心累加器分析**
若检测不到圆心，可能是梯度方向不准确或`param2`设置过高：
- **梯度方向验证**：通过`cv2.Sobel`计算梯度方向，观察是否指向圆心。
- **调试`param2`**：逐步降低`param2`，观察是否能检测到候选圆心。

#### **(3) 半径直方图统计**
对检测到的候选圆心，绘制半径分布直方图：
```python
distances = [np.sqrt((x - a)**2 + (y - b)**2) for (x, y) in edge_points]
plt.hist(distances, bins=50)
plt.show()
```
- **目标**：确定半径的集中区域，调整`minRadius`和`maxRadius`。

---

### **4. 常见问题与解决方案**
| **问题现象**               | **可能原因**                | **解决方案**                          |
|---------------------------|---------------------------|-------------------------------------|
| 检测不到圆                 | 边缘断裂、`param2`过高      | 降低`param1`和`param2`，检查预处理    |
| 检测到过多假圆             | 噪声干扰、`param2`过低      | 增大`param2`，加强降噪，限制半径范围   |
| 圆位置偏移                 | 梯度方向不准确              | 优化高斯滤波，验证梯度方向             |
| 邻近圆被合并               | `minDist`设置过大          | 减小`minDist`，增大`param2`           |
| 计算速度过慢               | 图像分辨率高、半径范围大    | 增大`dp`，限制半径范围，降低图像分辨率 |

---

### **5. 动态参数调优（实战技巧）**
使用滑动条实时调整参数，快速观察效果（适合复杂场景）：
```python
def nothing(x): pass

cv2.namedWindow('Hough Circles')
cv2.createTrackbar('param2', 'Hough Circles', 30, 100, nothing)
cv2.createTrackbar('minDist', 'Hough Circles', 20, 100, nothing)

while True:
    param2 = cv2.getTrackbarPos('param2', 'Hough Circles')
    minDist = cv2.getTrackbarPos('minDist', 'Hough Circles')
    
    circles = cv2.HoughCircles(img, cv2.HOUGH_GRADIENT, dp=1, minDist=minDist,
                              param1=50, param2=param2, minRadius=10, maxRadius=50)
    
    # 绘制圆并显示
    if circles is not None:
        cimg = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)
        for (x, y, r) in circles[0, :]:
            cv2.circle(cimg, (x, y), r, (0, 255, 0), 2)
        cv2.imshow('Hough Circles', cimg)
    
    if cv2.waitKey(10) & 0xFF == 27:
        break
```

---

### **6. 高级优化思路**
- **多尺度检测**：对同一图像使用不同`dp`值检测不同大小的圆。
- **颜色空间过滤**：在检测后，根据圆的颜色进一步筛选（例如只保留红色圆）。
- **形态学操作**：对边缘图像进行闭运算（`cv2.morphologyEx`）连接断裂边缘。

---

### **总结**
霍夫圆检测的调试核心是**平衡敏感度与特异性**：  
- **敏感度**（检测到真圆）：由`param1`（边缘）、`param2`（圆心投票）、`minRadius`控制。  
- **特异性**（排除假圆）：由`minDist`、`maxRadius`、降噪和`param2`控制。  

通过分步验证边缘质量、圆心候选和半径分布，结合动态参数调整，可高效解决大多数检测问题。

## 引用

+ https://zhuanlan.zhihu.com/p/448935812
+ https://blog.csdn.net/m0_74259636/article/details/132655935